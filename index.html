<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Theo d√µi c√¢n n·∫∑ng - Premium</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966481.png">
<style>
  :root {
    --bg: #ffffff;
    --card: #f7f9fc;
    --ink: #0b1220;
    --muted: #5b6576;
    --accent: #2563eb;
    --ok: #10b981;
    --warn: #f59e0b;
    --bad: #ef4444;
    --line: #e5e7eb;
    --goal: #9ca3af;
  }

  * { box-sizing: border-box; }
  html, body {
    margin: 0;
    background: var(--bg);
    color: var(--ink);
    font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
  }

  /* ==== HEADER PREMIUM ==== */
  header {
    padding: 28px 14px 18px;
    text-align: center;
    background: linear-gradient(135deg, #2563eb, #60a5fa);
    color: #fff;
    border-radius: 0 0 24px 24px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  }

  header h1 {
    font-size: 30px;
    font-weight: 800;
    letter-spacing: 0.5px;
    margin: 0;
    text-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }

  header .sub {
    font-size: 14px;
    opacity: 0.9;
    margin-top: 6px;
    letter-spacing: 0.4px;
  }

  @media (max-width: 480px) {
    header h1 { font-size: 22px; }
    header .sub { font-size: 12px; }
  }

  /* ==== C·∫§U TR√öC CHUNG ==== */
  .wrap { max-width: 1100px; margin: 0 auto; padding: 10px; }
  .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }

  .card {
    grid-column: span 12;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 6px 20px rgba(15,23,42,.06);
  }

  @media (min-width: 720px) {
    .card.sm-6 { grid-column: span 6; }
    .card.sm-4 { grid-column: span 4; }
    .card.sm-8 { grid-column: span 8; }
    .card.sm-12 { grid-column: span 12; }
  }

  .label { font-size: 12px; color: var(--muted); }
  .value { font-weight: 700; font-size: 20px; margin-top: 2px; }

  .form-row { display: flex; gap: 8px; flex-wrap: wrap; }
  input, button, select {
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: #fff;
    color: var(--ink);
  }

  button {
    background: var(--accent);
    color: #fff;
    border: none;
    cursor: pointer;
    transition: transform .06s, background .2s;
  }

  button:hover { background: #1d4ed8; }
  button:active { transform: translateY(1px); }
  button.ghost { background: #fff; color: var(--ink); border: 1px solid var(--line); }
  button:disabled { opacity: .6; cursor: not-allowed; }

  .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--line); background: #fff; }

  table { width: 100%; border-collapse: collapse; }
  th, td {
    border-bottom: 1px solid var(--line);
    padding: 10px 8px;
    text-align: left;
    font-size: 14px;
    vertical-align: top;
  }

  th { font-weight: 700; background: #fff; position: sticky; top: 0; z-index: 2; }
  tbody tr:hover { background: #fafafa; }

  .muted { color: var(--muted); }
  canvas { width: 100%; height: 300px; display: block; border-radius: 12px; background: #fff; border: 1px solid var(--line); }
  .tags { display: flex; gap: 6px; flex-wrap: wrap; }
  .hint { font-size: 12px; color: var(--muted); }
  .ok { color: var(--ok); }
  .bad { color: var(--bad); }
  .warn { color: var(--warn); }
  .entered { background: #ecfeff; } /* ng√†y ƒë√£ nh·∫≠p */
  .badge { display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: 11px; border: 1px solid var(--line); background: #fff; }

  /* ==== ALERT ==== */
  .alert {
    border: 1px solid #fde68a;
    background: #fff8e1;
    color: #92400e;
    border-radius: 12px;
    line-height: 1.5;
    font-size: 14px;
    padding: 12px;
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ==== B·∫¢NG LOG ==== */
  #logTable th:first-child,
  #logTable td:first-child {
    min-width: 100px;
    white-space: nowrap;
  }

  #logTable { min-width: 650px; }

  @media (max-width: 480px) {
    .wrap { padding: 6px; }
    .card { padding: 10px; }
    #logTable th:first-child,
    #logTable td:first-child { min-width: 90px; }
  }
</style>
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Theo d√µi c√¢n n·∫∑ng">
<link rel="apple-touch-icon" href="icon-192.png">


</head>
<body>
<header>
  <h1>üìä Theo d√µi c√¢n n·∫∑ng <span style="opacity:0.9;font-weight:600;">‚Äì Premium</span></h1>
  <div class="sub">Qu·∫£n l√Ω s·ª©c kh·ªèe m·ªói ng√†y ‚Ä¢ D·ªØ li·ªáu ƒë·ªìng b·ªô th√¥ng minh ‚òÅÔ∏è</div>
</header>


<div class="wrap">
  <div class="row">
    <div class="card sm-8">
      <div class="form-row">
        <label class="pill">Ng√†y b·∫Øt ƒë·∫ßu: <b id="startLabel"></b></label>
        <label class="pill">BMI m·ª•c ti√™u: <b id="bmiGoalLabel"></b></label>
        <label class="pill">C√¢n n·∫∑ng m·ª•c ti√™u: <b id="goalLabel"></b> kg</label>
        <label class="pill">TB 7 ng√†y g·∫ßn nh·∫•t: <b id="avg7Label"></b> kg</label>
      </div>
      <div style="margin-top:10px" class="form-row">
        <input type="date" id="dateInput">
        <input type="number" step="0.1" id="weightInput" placeholder="C√¢n n·∫∑ng h√¥m nay (kg)">
        <button id="saveBtn">L∆∞u</button>
        <button class="ghost" id="clearBtn">Xo√° c√¢n n·∫∑ng ng√†y n√†y</button>
      </div>
      <div class="hint" style="margin-top:8px">M·∫πo: ch·∫°m v√†o c√¢n n·∫∑ng trong b·∫£ng ƒë·ªÉ s·ª≠a nhanh. Gi√° tr·ªã nh·∫≠p t·∫°m ƒë∆∞·ª£c gi·ªØ l·∫°i n·∫øu reload.</div>
    </div>

    <div class="card sm-4">
      <div class="label">D·ª± ƒëo√°n ƒë·∫°t m·ª•c ti√™u</div>
      <div class="value" id="etaValue">‚Äî</div>
      <div class="hint">D·ª±a tr√™n t·ªëc ƒë·ªô 14 ng√†y g·∫ßn nh·∫•t v√† h∆∞·ªõng m·ª•c ti√™u.</div>
      <div id="gainAlert" style="margin-top:10px;display:none" class="alert">C·∫£nh b√°o: b·∫°n ƒëang tƒÉng c√¢n 3 ng√†y li√™n ti·∫øp. H√£y xem l·∫°i ƒÉn m·∫∑n/tinh b·ªôt ban ƒë√™m v√† tƒÉng v·∫≠n ƒë·ªông nh·∫π.</div>
    </div>

    <div class="card sm-4">
      <div class="label">C√¢n n·∫∑ng g·∫ßn nh·∫•t</div>
      <div class="value" id="latestWeight">‚Äî</div>
      <div class="label" style="margin-top:8px">BMI g·∫ßn nh·∫•t</div>
      <div class="value" id="latestBMI">‚Äî</div>
    </div>
    <div class="card sm-4">
      <div class="label">% Ho√†n th√†nh</div>
      <div class="value" id="progressValue">‚Äî</div>
      <div class="label" style="margin-top:8px">C√≤n l·∫°i</div>
      <div class="value" id="remainValue">‚Äî</div>
    </div>
    <div class="card sm-4">
      <div class="label">T·ªëc ƒë·ªô 14 ng√†y</div>
      <div class="value" id="rate14">‚Äî</div>
      <div class="hint">kg/tu·∫ßn (√¢m l√† gi·∫£m c√¢n).</div>
    </div>

    <div class="card sm-12" style="position:relative">
      <canvas id="chart"></canvas>
      <div id="chartTip" class="tooltip" style="display:none"></div>
    </div>

    <div class="card sm-12">
      <div class="form-row" style="justify-content:space-between;align-items:center">
        <div class="tags">
          <span class="pill">Xu·∫•t/nh·∫≠p d·ªØ li·ªáu</span>
        </div>
        <div class="form-row">
          <button class="ghost" id="exportBtn">Xu·∫•t JSON</button>
          <input type="file" id="importFile" accept=".json" style="display:none">
          <button class="ghost" id="importBtn">Nh·∫≠p JSON</button>
          <button class="ghost" id="resetBtn">Xo√° to√†n b·ªô</button>
        </div>
      </div>
    </div>

    <div class="card sm-12">
      <div class="label">Nh·∫≠t k√Ω (vu·ªët ngang ƒë·ªÉ xem h·∫øt)</div>
      <div style="overflow:auto">
        <table id="logTable">
          <thead>
            <tr>
              <th>Ng√†y</th>
              <th>C√¢n n·∫∑ng (kg)</th>
              <th>BMI</th>
              <th>% Ho√†n th√†nh</th>
              <th>L·ªùi khuy√™n AI</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// ====== C·∫§U H√åNH C√Å NH√ÇN ======
const HEIGHT_CM = 170;
const START_WEIGHT = 109.7;
const TARGET_BMI = 22;
const START_DATE = new Date("2025-09-29");
const DAYS = 365;
const GOAL_WEIGHT = Math.round(((HEIGHT_CM/100)**2 * TARGET_BMI)*10)/10;

// ====== L∆ØU TR·ªÆ ======
const KEY = "weight-tracker-170cm-2025";
const KEY_TMP = "weight-tracker-tmp";
function loadData(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return {};
  try { return JSON.parse(raw) || {}; } catch(e){ return {}; }
}
function saveData(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

// gi·ªØ gi√° tr·ªã nh·∫≠p t·∫°m
function loadTmp(){ try{ return JSON.parse(localStorage.getItem(KEY_TMP)||"{}"); }catch(e){return{}} }
function saveTmp(obj){ localStorage.setItem(KEY_TMP, JSON.stringify(obj||{})); }

// ====== TI·ªÜN √çCH ======
function fmtDate(d){ const z=(n)=>String(n).padStart(2,"0"); return d.getFullYear()+"-"+z(d.getMonth()+1)+"-"+z(d.getDate()); }
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function movingAvg(arr, window){
  const out = new Array(arr.length).fill(null);
  for(let i=0;i<arr.length;i++){
    let s=0,c=0;
    for(let j=Math.max(0,i-window+1);j<=i;j++){
      const v = arr[j];
      if(v!=null){ s+=v; c++; }
    }
    out[i]= c? s/c : null;
  }
  return out;
}
function lastNonNull(arr){
  for(let i=arr.length-1;i>=0;i--) if(arr[i]!=null) return {index:i, value:arr[i]};
  return null;
}

// ====== KH·ªûI T·∫†O D√ÉY NG√ÄY ======
const dates = Array.from({length:DAYS}, (_,i)=>{ const d = new Date(START_DATE); d.setDate(d.getDate()+i); return d; });
document.getElementById("startLabel").textContent = fmtDate(START_DATE);
document.getElementById("bmiGoalLabel").textContent = TARGET_BMI;
document.getElementById("goalLabel").textContent = GOAL_WEIGHT.toFixed(1);

// ƒêi·ªÅn ng√†y m·∫∑c ƒë·ªãnh = h√¥m nay (n·∫øu n·∫±m trong ph·∫°m vi)
const today = new Date(); today.setHours(0,0,0,0);
let defaultDate = today;
if(today < START_DATE) defaultDate = START_DATE;
if(today > dates[dates.length-1]) defaultDate = dates[dates.length-1];
document.getElementById("dateInput").value = fmtDate(defaultDate);

// ====== T·∫¢I D·ªÆ LI·ªÜU ======
let data = loadData(); // map yyyy-mm-dd -> weight
let tmp = loadTmp();   // {dateInput, weightInput}

// N·∫øu c√≥ gi√° tr·ªã nh·∫≠p t·∫°m, hi·ªÉn th·ªã l·∫°i
if(tmp.weightInput){ document.getElementById("weightInput").value = tmp.weightInput; }
document.getElementById("weightInput").addEventListener("input", (e)=>{ tmp.weightInput = e.target.value; saveTmp(tmp); });

// ====== AI MINI L·ªúI KHUY√äN (phi√™n b·∫£n chu·∫©n & chuy√™n s√¢u) ======
// ====== AI MINI L·ªúI KHUY√äN (phi√™n b·∫£n t·ªëi ∆∞u & chuy√™n s√¢u nh·∫•t) ======
function adviceForDelta(d){
  if (d == null || isNaN(d)) return "";

  // l√†m tr√≤n g·ªçn hi·ªÉn th·ªã
  const abs = Math.abs(d);
  const dd = (d > 0 ? "+" : "") + (Math.round(d * 10) / 10).toFixed(1);

  // === ·ªîN ƒê·ªäNH ===
  if (abs < 0.1) {
    return `‚öñÔ∏è ·ªîn ƒë·ªãnh (${dd}kg). C∆° th·ªÉ ƒëang ·ªü tr·∫°ng th√°i c√¢n b·∫±ng.
üëâ Duy tr√¨:
‚Ä¢ ƒÇn ƒë√∫ng b·ªØa, kh√¥ng b·ªè b·ªØa s√°ng
‚Ä¢ Ng·ªß ƒë·ªß 7‚Äì8 ti·∫øng, tr√°nh stress
‚Ä¢ U·ªëng ƒë·ªß 2L n∆∞·ªõc/ng√†y
‚Ä¢ Ti·∫øp t·ª•c t·∫≠p nh·∫π ho·∫∑c ƒëi b·ªô ƒë·ªÅu`;
  }

  // === GI·∫¢M C√ÇN ===
  if (d < 0) {
    if (abs >= 1.5)
      return `üö® Gi·∫£m r·∫•t nhanh (${dd}kg)! C√≥ th·ªÉ m·∫•t n∆∞·ªõc ho·∫∑c thi·∫øu nƒÉng l∆∞·ª£ng.
üëâ N√™n:
‚Ä¢ ƒÇn ƒë·ªß 3 b·ªØa, th√™m 1 b·ªØa ph·ª• c√≥ ƒë·∫°m
‚Ä¢ U·ªëng 2‚Äì2.5L n∆∞·ªõc/ng√†y
‚Ä¢ Ngh·ªâ ng∆°i nhi·ªÅu h∆°n, tr√°nh t·∫≠p n·∫∑ng
‚Ä¢ Theo d√µi n·∫øu m·ªát, hoa m·∫Øt ho·∫∑c ng·ªß k√©m`;

    if (abs >= 1.0)
      return `üí™ Gi·∫£m m·∫°nh (${dd}kg). Ti·∫øn ƒë·ªô r·∫•t t·ªët!
üëâ G·ª£i √Ω:
‚Ä¢ Gi·ªØ kh·∫©u ph·∫ßn ƒë·∫°m 1.6‚Äì2g/kg
‚Ä¢ H·∫°n ch·∫ø tinh b·ªôt tr·∫Øng, tƒÉng rau xanh
‚Ä¢ ƒÇn t·ªëi s·ªõm (tr∆∞·ªõc 19h30)
‚Ä¢ Tr√°nh b·ªè b·ªØa ho·∫∑c nh·ªãn ƒÉn c·ª±c ƒëoan`;

    if (abs >= 0.6)
      return `‚úÖ Gi·∫£m ·ªïn ƒë·ªãnh (${dd}kg). Ti·∫øn ƒë·ªô l√Ω t∆∞·ªüng.
üëâ Ti·∫øp t·ª•c:
‚Ä¢ U·ªëng n∆∞·ªõc ƒë·ªÅu trong ng√†y
‚Ä¢ ƒÇn ch·∫≠m, nhai k·ªπ
‚Ä¢ Duy tr√¨ ng·ªß s·ªõm & gi·∫£m ƒë·ªì chi√™n r√°n
‚Ä¢ T·∫≠p v·ª´a s·ª©c (ƒëi b·ªô, plank, yoga)`;

    if (abs >= 0.3)
      return `üåø Gi·∫£m nh·∫π (${dd}kg). Ho√†n to√†n b√¨nh th∆∞·ªùng.
üëâ Duy tr√¨:
‚Ä¢ Gi·∫£m tinh b·ªôt bu·ªïi t·ªëi
‚Ä¢ TƒÉng rau & tr√°i c√¢y t∆∞∆°i
‚Ä¢ ƒêi b·ªô 6‚Äì8k b∆∞·ªõc/ng√†y
‚Ä¢ Theo d√µi th√™m v√†i ng√†y n·ªØa ƒë·ªÉ th·∫•y xu h∆∞·ªõng`;

    return `üí§ Gi·∫£m r·∫•t nh·∫π (${dd}kg) ‚Äî dao ƒë·ªông do n∆∞·ªõc ho·∫∑c mu·ªëi.
üëâ U·ªëng ƒë·ªß n∆∞·ªõc, ng·ªß s·ªõm v√† ƒÉn nh·∫°t 1‚Äì2 ng√†y.`;
  }

  // === TƒÇNG C√ÇN ===
  if (d > 0) {
    if (d >= 1.2)
      return `‚ùó TƒÉng nhanh (${dd}kg)! C√≥ th·ªÉ do ‚Äúcheat day‚Äù ho·∫∑c ƒÉn t·ªëi mu·ªôn.
üëâ C·∫ßn:
‚Ä¢ ƒÇn nh·∫°t 2 ng√†y, c·∫Øt ƒë·ªì ng·ªçt v√† n∆∞·ªõc c√≥ gas
‚Ä¢ U·ªëng 2.5L n∆∞·ªõc/ng√†y
‚Ä¢ TƒÉng v·∫≠n ƒë·ªông (ƒëi b·ªô 8k‚Äì10k b∆∞·ªõc/ng√†y)
‚Ä¢ Tr√°nh th·ª©c khuya & ƒë·ªì ƒÉn khuya`;

    if (d >= 0.8)
      return `üö© TƒÉng r√µ (${dd}kg). C∆° th·ªÉ c√≥ th·ªÉ t√≠ch n∆∞·ªõc ho·∫∑c d∆∞ calo.
üëâ G·ª£i √Ω:
‚Ä¢ Ghi l·∫°i th·ª±c ƒë∆°n 2‚Äì3 ng√†y g·∫ßn nh·∫•t
‚Ä¢ Gi·∫£m 25‚Äì30% tinh b·ªôt bu·ªïi t·ªëi
‚Ä¢ ƒÇn ch·∫≠m, nhai k·ªπ, h·∫°n ch·∫ø snack
‚Ä¢ ƒêi b·ªô nhanh 30 ph√∫t m·ªói ng√†y`;

    if (d >= 0.5)
      return `ü•Ø TƒÉng nh·∫π v·ª´a (${dd}kg). C√≥ th·ªÉ do ƒÉn m·∫∑n ho·∫∑c √≠t v·∫≠n ƒë·ªông.
üëâ Kh·∫Øc ph·ª•c:
‚Ä¢ Gi·∫£m tinh b·ªôt tr·∫Øng, ƒÉn nh·∫°t h∆°n
‚Ä¢ U·ªëng n∆∞·ªõc ·∫•m tr∆∞·ªõc b·ªØa ƒÉn
‚Ä¢ Kh√¥ng ƒÉn v·∫∑t sau 20h
‚Ä¢ Ng·ªß ƒë·ªß gi·∫•c ƒë·ªÉ gi·∫£m cortisol`;

    if (d >= 0.3)
      return `üìà TƒÉng nh·∫π (${dd}kg). Dao ƒë·ªông t·∫°m th·ªùi l√† b√¨nh th∆∞·ªùng.
üëâ M·∫πo:
‚Ä¢ U·ªëng th√™m n∆∞·ªõc, h·∫°n ch·∫ø mu·ªëi
‚Ä¢ ƒÇn nhi·ªÅu rau xanh, tr√°i c√¢y t∆∞∆°i
‚Ä¢ T·∫≠p nh·∫π (ƒëi b·ªô 15 ph√∫t sau ƒÉn t·ªëi)
‚Ä¢ Ki·ªÉm tra l·∫°i l∆∞·ª£ng n∆∞·ªõc n·∫°p trong ng√†y`;

    return `üôÇ TƒÉng r·∫•t nh·∫π (${dd}kg) ‚Äî bi·∫øn ƒë·ªông nh·ªè trong gi·ªõi h·∫°n an to√†n.
üëâ Duy tr√¨ ƒÉn u·ªëng ƒëi·ªÅu ƒë·ªô, theo d√µi 2‚Äì3 ng√†y t·ªõi ƒë·ªÉ xem xu h∆∞·ªõng.`;
  }

  return "";
}



// ====== T√çNH TO√ÅN CH√çNH ======
function recompute(){
  // Build aligned arrays
  const weights = dates.map(d => {
    const w = data[fmtDate(d)];
    return (typeof w==="number" && w>0)? w : null;
  });
  const bmi = weights.map(w => w==null ? null : w/((HEIGHT_CM/100)**2));
  // progress%
  const progress = weights.map(w => {
    if(w==null) return null;
    if(GOAL_WEIGHT < START_WEIGHT){ // gi·∫£m c√¢n
      const p = (START_WEIGHT - w) / (START_WEIGHT - GOAL_WEIGHT);
      return clamp(p,0,1);
    } else { // tƒÉng c√¢n
      const p = (w - START_WEIGHT) / (GOAL_WEIGHT - START_WEIGHT);
      return clamp(p,0,1);
    }
  });
  // 7-day avg
  const avg7 = movingAvg(weights, 7);

  // 14-day rate (kg/tu·∫ßn)
  let rate14 = null;
  for(let i=14;i<weights.length;i++){
    const a = weights[i-14], b = weights[i];
    if(a!=null && b!=null) rate14 = (b - a)/14*7;
  }

  // Trung b√¨nh 7 ng√†y g·∫ßn nh·∫•t (hi·ªÉn th·ªã)
  const lastAvg = lastNonNull(avg7);
  document.getElementById("avg7Label").textContent = lastAvg? lastAvg.value.toFixed(1) : "‚Äî";

  // Metrics g·∫ßn nh·∫•t
  const lastW = lastNonNull(weights);
  const lastB = lastNonNull(bmi);
  const lastP = lastNonNull(progress);

  const latestWeight = document.getElementById("latestWeight");
  const latestBMI = document.getElementById("latestBMI");
  const progressValue = document.getElementById("progressValue");
  const remainValue = document.getElementById("remainValue");
  const rate14El = document.getElementById("rate14");
  const etaValue = document.getElementById("etaValue");

  latestWeight.textContent = lastW? lastW.value.toFixed(1)+" kg" : "‚Äî";
  latestBMI.textContent = lastB? lastB.value.toFixed(1) : "‚Äî";
  progressValue.textContent = lastP? Math.round(lastP.value*100)+"%" : "‚Äî";
  remainValue.textContent = lastW? Math.abs(lastW.value - GOAL_WEIGHT).toFixed(1)+" kg":"‚Äî";
  rate14El.textContent = (rate14==null? "‚Äî" : rate14.toFixed(2));

  // D·ª± ƒëo√°n ng√†y ƒë·∫°t + s·ªë ng√†y c√≤n l·∫°i
  let eta = "‚Äî";
  if(lastW && rate14!=null){
    const dir = (GOAL_WEIGHT<START_WEIGHT)? -1 : 1;
    if((dir === -1 && rate14 < 0) || (dir === 1 && rate14 > 0)){
      const weeks = Math.abs((lastW.value - GOAL_WEIGHT) / rate14);
      const daysNeed = Math.round(weeks*7);
      const from = dates[lastW.index] || today;
      const etaDate = new Date(from); etaDate.setDate(etaDate.getDate()+daysNeed);
      eta = fmtDate(etaDate) + " (‚âà " + daysNeed + " ng√†y n·ªØa)";
    }
  }
  etaValue.textContent = eta;

  // C·∫£nh b√°o tƒÉng 3 ng√†y li√™n ti·∫øp
// === C·∫¢NH B√ÅO TH√îNG MINH ===
const alertBox = document.getElementById("gainAlert");
alertBox.style.display = "none";

let upCount = 0, downCount = 0;
for (let i = weights.length - 1; i >= 1; i--) {
  if (weights[i] == null || weights[i - 1] == null) continue;
  const diff = weights[i] - weights[i - 1];
  if (diff > 0.1) upCount++;
  else if (diff < -0.1) downCount++;
  else break;
  if (upCount >= 3 || downCount >= 3) break;
}

if (upCount >= 3) {
  alertBox.textContent =
    "‚ö†Ô∏è B·∫°n ƒëang tƒÉng c√¢n 3 ng√†y li√™n ti·∫øp. H√£y ki·ªÉm tra l·∫°i kh·∫©u ph·∫ßn tinh b·ªôt, ƒÉn nh·∫°t h∆°n v√† tƒÉng v·∫≠n ƒë·ªông nh·∫π üí™";
  alertBox.style.display = "block";
} else if (downCount >= 3) {
  alertBox.textContent =
    "üéâ B·∫°n gi·∫£m li√™n t·ª•c 3 ng√†y r·ªìi! Duy tr√¨ nh·ªãp ƒë·ªô, nh·ªõ ƒÉn ƒë·ªß ƒë·∫°m v√† ng·ªß ngon ƒë·ªÉ gi·ªØ s·ª©c kh·ªèe ‚ù§Ô∏è";
  alertBox.style.display = "block";
}

  // Render b·∫£ng
  renderTable(weights, bmi, progress);

  // V·∫Ω bi·ªÉu ƒë·ªì m∆∞·ª£t + ƒë∆∞·ªùng m·ª•c ti√™u
  drawChart(weights, avg7);
}

function renderTable(weights, bmi, progress){
  const tb = document.querySelector("#logTable tbody");
  tb.innerHTML = "";
  for(let i=0;i<dates.length;i++){
    const tr = document.createElement("tr");
    const d = fmtDate(dates[i]);

    const tdDate = document.createElement("td");
    tdDate.textContent = d;

    const tdW = document.createElement("td");
    tdW.textContent = weights[i]!=null ? weights[i].toFixed(1): "";
    tdW.className = "editable";
    tdW.style.cursor="text";
    if(weights[i]!=null){ tr.classList.add("entered"); }
    tdW.onclick = ()=>{
      const val = prompt("Nh·∫≠p c√¢n n·∫∑ng (kg) cho ng√†y "+d, tdW.textContent || (tmp.weightInput||""));
      if(val===null) return;
      const num = parseFloat(val);
      if(!isNaN(num) && num>0){
        data[d] = Math.round(num*10)/10;
      }else{
        delete data[d];
      }
      saveData(data);
      recompute();
    };

    const tdB = document.createElement("td");
    const bmiVal = weights[i]==null ? null : weights[i]/((HEIGHT_CM/100)**2);
    tdB.textContent = bmiVal!=null ? bmiVal.toFixed(1): "";

    const tdP = document.createElement("td");
    let prog = null;
    if(weights[i]!=null){
      if(GOAL_WEIGHT < START_WEIGHT){
        prog = (START_WEIGHT - weights[i])/(START_WEIGHT - GOAL_WEIGHT);
      }else{
        prog = (weights[i] - START_WEIGHT)/(GOAL_WEIGHT - START_WEIGHT);
      }
      prog = clamp(prog,0,1);
    }
    tdP.textContent = prog!=null ? Math.round(prog*100)+"%" : "";
    if(prog!=null){
      if(prog >= 0.8) tdP.className="ok";
      else if(prog >= 0.4) tdP.className="warn";
      else tdP.className="bad";
    }

    // L·ªùi khuy√™n AI: d·ª±a tr√™n delta so v·ªõi ng√†y tr∆∞·ªõc
    let delta = null;
    if(i>0 && weights[i]!=null){
      const prev = weights[i-1];
      if(prev!=null) delta = weights[i] - prev;
    }
    const tdAdv = document.createElement("td");
    tdAdv.textContent = adviceForDelta(delta);

    tr.appendChild(tdDate);
    tr.appendChild(tdW);
    tr.appendChild(tdB);
    tr.appendChild(tdP);
    tr.appendChild(tdAdv);
    tb.appendChild(tr);
  }
}

// ====== V·∫º BI·ªÇU ƒê·ªí M∆Ø·ª¢T (CANVAS THU·∫¶N) ======
function drawChart(series, avg7){
  const canvas = document.getElementById("chart");
  const tip = document.getElementById("chartTip");
  const ctx = canvas.getContext("2d");
  const W = canvas.clientWidth, H = canvas.clientHeight;
  const DPR = window.devicePixelRatio || 1;
  canvas.width = Math.floor(W*DPR);
  canvas.height = Math.floor(H*DPR);
  ctx.scale(DPR,DPR);

  ctx.clearRect(0,0,W,H);
  const pL=42,pR=12,pT=12,pB=28;
  const plotW=W-pL-pR, plotH=H-pT-pB;

  // bounds
  const vals = series.filter(v=>v!=null);
  const vals2 = avg7.filter(v=>v!=null);
  const all = vals.concat(vals2);
  if(all.length===0){
    ctx.fillStyle="#6b7280"; ctx.fillText("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì", pL, pT+16); return;
  }
  const minV = Math.min(...all), maxV = Math.max(...all);
  const pad = Math.max(1,(maxV-minV)*0.12);
  const yMin = Math.min(minV - pad, GOAL_WEIGHT - 1);
  const yMax = Math.max(maxV + pad, GOAL_WEIGHT + 1);

  // axes
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pL, pT); ctx.lineTo(pL, pT+plotH); ctx.lineTo(pL+plotW, pT+plotH); ctx.stroke();

  // y ticks
  ctx.fillStyle="#6b7280"; ctx.font="12px system-ui";
  const steps = 4;
  for(let i=0;i<=steps;i++){
    const t = yMin + (i/steps)*(yMax-yMin);
    const y = pT + plotH - (t - yMin)/(yMax-yMin)*plotH;
    ctx.beginPath(); ctx.moveTo(pL,y); ctx.lineTo(pL+plotW,y); ctx.strokeStyle="#f1f5f9"; ctx.stroke();
    ctx.fillText(t.toFixed(1), 4, y+4);
  }

  function xAt(i){ return pL + (i/(series.length-1))*plotW; }
  function yAt(v){ return pT + plotH - (v - yMin)/(yMax-yMin)*plotH; }

  // goal line
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--goal').trim() || "#9ca3af";
  ctx.setLineDash([6,6]); ctx.lineWidth=1.5;
  ctx.beginPath(); ctx.moveTo(pL, yAt(GOAL_WEIGHT)); ctx.lineTo(pL+plotW, yAt(GOAL_WEIGHT)); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle="#6b7280"; ctx.fillText("M·ª•c ti√™u " + GOAL_WEIGHT.toFixed(1)+"kg", pL+6, yAt(GOAL_WEIGHT)-6);

  // smooth path helper (Catmull-Rom to Bezier)
  function smoothPath(points){
    if(points.length<2) return null;
    const path = [];
    for(let i=0;i<points.length-1;i++){
      const p0 = points[i-1] || points[i];
      const p1 = points[i];
      const p2 = points[i+1];
      const p3 = points[i+2] || p2;
      const cp1x = p1.x + (p2.x - p0.x)/6;
      const cp1y = p1.y + (p2.y - p0.y)/6;
      const cp2x = p2.x - (p3.x - p1.x)/6;
      const cp2y = p2.y - (p3.y - p1.y)/6;
      path.push({p1,cp1:{x:cp1x,y:cp1y},cp2:{x:cp2x,y:cp2y},p2});
    }
    return path;
  }

  // collect points (weight)
  const pts = [];
  for(let i=0;i<series.length;i++){
    const v = series[i];
    if(v==null) continue;
    pts.push({i, x:xAt(i), y:yAt(v), v});
  }
  // draw weight line
  if(pts.length){
    const path = smoothPath(pts);
    ctx.strokeStyle="#2563eb"; ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    if(path){
      for(const seg of path){
        ctx.bezierCurveTo(seg.cp1.x, seg.cp1.y, seg.cp2.x, seg.cp2.y, seg.p2.x, seg.p2.y);
      }
    }
    ctx.stroke();
  }

  // avg7 line
  const ptsAvg = [];
  for(let i=0;i<avg7.length;i++){
    const v = avg7[i]; if(v==null) continue;
    ptsAvg.push({i, x:xAt(i), y:yAt(v), v});
  }
  if(ptsAvg.length){
    const path2 = smoothPath(ptsAvg);
    ctx.strokeStyle="#0ea5e9"; ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(ptsAvg[0].x, ptsAvg[0].y);
    if(path2){
      for(const seg of path2){
        ctx.bezierCurveTo(seg.cp1.x, seg.cp1.y, seg.cp2.x, seg.cp2.y, seg.p2.x, seg.p2.y);
      }
    }
    ctx.stroke();
  }

  // x labels (first/mid/last)
  ctx.fillStyle="#6b7280";
  const first = fmtDate(dates[0]);
  const mid = fmtDate(dates[Math.floor(dates.length/2)]);
  const last = fmtDate(dates[dates.length-1]);
  ctx.fillText(first, pL, H-6);
  ctx.fillText(mid, pL+plotW/2-30, H-6);
  ctx.fillText(last, pL+plotW-80, H-6);

  // tooltip interactions
  function nearestPoint(mx){
    let best=null, bestDist=1e9;
    const arr = pts.length? pts: ptsAvg;
    for(const p of arr){
      const dx = Math.abs(p.x - mx);
      if(dx < bestDist){ best = p; bestDist = dx; }
    }
    return best;
  }

  function showTip(p){
    if(!p){ tip.style.display="none"; return; }
    tip.style.display="block";
    tip.style.left = p.x + "px";
    tip.style.top = p.y + "px";
    tip.textContent = fmtDate(dates[p.i]) + " ‚Ä¢ " + p.v.toFixed(1) + " kg";
  }

  function handleMove(evt){
    const rect = canvas.getBoundingClientRect();
    const x = (evt.touches? evt.touches[0].clientX: evt.clientX) - rect.left;
    showTip(nearestPoint(x));
  }
  canvas.onmousemove = handleMove;
  canvas.ontouchstart = handleMove;
  canvas.ontouchmove = handleMove;
  canvas.onmouseleave = ()=> tip.style.display="none";
}

document.getElementById("saveBtn").onclick = async ()=>{
  const d = document.getElementById("dateInput").value;
  const w = parseFloat(document.getElementById("weightInput").value);
  if(!d || isNaN(w) || w<=0){ alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ng√†y v√† c√¢n n·∫∑ng h·ª£p l·ªá."); return; }
  const dd = new Date(d);
  if(dd < START_DATE || dd > dates[dates.length-1]){
    alert("‚ö†Ô∏è Ng√†y n·∫±m ngo√†i ph·∫°m vi theo d√µi."); return;
  }

  // L∆∞u c√¢n n·∫∑ng
  data[d] = Math.round(w*10)/10;
  saveData(data);
  tmp.weightInput = ""; saveTmp(tmp);
  document.getElementById("weightInput").value="";
  recompute();

  // Th√¥ng b√°o
  alert("‚úÖ ƒê√£ l∆∞u c√¢n n·∫∑ng!");

  // T·ª± ƒë·ªìng b·ªô l√™n GitHub Gist
  await syncToGist();
};


document.getElementById("clearBtn").onclick = ()=>{
  const d = document.getElementById("dateInput").value;
  if(!d){ alert("Ch∆∞a ch·ªçn ng√†y."); return; }
  delete data[d];
  saveData(data);
  recompute();
};

document.getElementById("exportBtn").onclick = ()=>{
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "can-nang-data.json";
  a.click();
};

document.getElementById("importBtn").onclick = ()=> document.getElementById("importFile").click();
document.getElementById("importFile").onchange = (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      data = obj && typeof obj==="object" ? obj : {};
      saveData(data);
      recompute();
      alert("Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!");
    }catch(err){ alert("File kh√¥ng h·ª£p l·ªá."); }
  };
  reader.readAsText(file);
};

document.getElementById("resetBtn").onclick = ()=>{
  if(confirm("Xo√° to√†n b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u tr√™n m√°y n√†y?")){
    localStorage.removeItem(KEY);
    localStorage.removeItem(KEY_TMP);
    data={}; tmp={};
    recompute();
  }
};
// ====== ƒê·ªíNG B·ªò GITHUB GIST (an to√†n, kh√¥ng l·ªô token) ======

// L∆∞u token v√† gist ID v√†o localStorage
const KEY_GIST = "weight-tracker:gist";
function loadGistInfo(){
  try { return JSON.parse(localStorage.getItem(KEY_GIST)||"{}"); }catch(e){return{};}
}
function saveGistInfo(o){ localStorage.setItem(KEY_GIST, JSON.stringify(o)); }

async function askGistInfo(){
  const info = loadGistInfo();
  
  let gistId = prompt("Nh·∫≠p Gist ID: 1f849577016aeb8150c4ffe2e43ddc1b", info.gistId || "");
  if(!gistId) return null;
  let token = prompt("Nh·∫≠p GitHub Token: ", info.token || "");
  if(!token) return null;
  const obj = { gistId, token };
  saveGistInfo(obj);
  return obj;
}

// ====== ‚òÅÔ∏è ƒê·ªíNG B·ªò GITHUB GIST 2 CHI·ªÄU (C√ì TH√îNG B√ÅO) ======
async function syncToGist(){
  let { gistId, token } = loadGistInfo();
  if (!gistId || !token) {
    const got = await askGistInfo();
    if (!got) return alert("‚ö†Ô∏è Ch∆∞a nh·∫≠p ƒë·ªß th√¥ng tin Gist.");
    gistId = got.gistId;
    token = got.token;
  }

  try {
    const currentData = loadData();
    currentData._updatedAt = new Date().toISOString();
    saveData(currentData);

    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: "PATCH",
      headers: {
        "Authorization": "token " + token,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        files: {
          "can-nang-data.json": {
            content: JSON.stringify(currentData, null, 2),
          },
        },
      }),
    });

    if (res.ok) {
      alert("‚úÖ ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu l√™n GitHub Gist th√†nh c√¥ng!");
    } else {
      const text = await res.text();
      alert("‚ö†Ô∏è L·ªói ƒë·ªìng b·ªô Gist:\n" + text.slice(0, 200));
    }
  } catch (e) {
    alert("‚ùå Kh√¥ng th·ªÉ ƒë·ªìng b·ªô Gist: " + e.message);
    console.error(e);
  }
}

async function loadFromGist() {
  let { gistId, token } = loadGistInfo();
  if (!gistId || !token) {
    const got = await askGistInfo();
    if (!got) return;
    gistId = got.gistId;
    token = got.token;
  }

  try {
    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: { Authorization: "token " + token },
    });
    const gist = await res.json();
    const content = gist.files["can-nang-data.json"]?.content;
    if (!content) {
      alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file can-nang-data.json tr√™n Gist!");
      return;
    }

    const remote = JSON.parse(content);
    const local = loadData();

    const localTime = new Date(local._updatedAt || 0);
    const remoteTime = new Date(remote._updatedAt || 0);

    if (remoteTime > localTime) {
      saveData(remote);
      data = remote;
      recompute();
      alert("üì• ƒê√£ t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ GitHub Gist!");
    } else if (localTime > remoteTime) {
      alert("üÜó D·ªØ li·ªáu trong m√°y m·ªõi h∆°n, gi·ªØ nguy√™n.");
    } else {
      alert("‚ÑπÔ∏è D·ªØ li·ªáu ƒë√£ ƒë·ªìng b·ªô, kh√¥ng c√≥ thay ƒë·ªïi.");
    }
  } catch (e) {
    alert("‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Gist: " + e.message);
    console.error(e);
  }
}

// Khi m·ªü trang, t·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu Gist n·∫øu c√≥
window.addEventListener("DOMContentLoaded", () => {
  loadFromGist();
});
// ====== N√öT GIAO DI·ªÜN ƒê·ªíNG B·ªò GIST ======
window.addEventListener("DOMContentLoaded", ()=>{
  const wrap = document.querySelector("#exportBtn").parentNode;

  // N√∫t ƒë·ªìng b·ªô l√™n GitHub
  const btnSync = document.createElement("button");
  btnSync.textContent = "‚¨ÜÔ∏è ƒê·ªìng b·ªô l√™n GitHub";
  btnSync.className = "ghost";
  btnSync.onclick = syncToGist;
  wrap.appendChild(btnSync);

  // N√∫t t·∫£i d·ªØ li·ªáu t·ª´ GitHub
  const btnLoad = document.createElement("button");
  btnLoad.textContent = "‚¨áÔ∏è T·∫£i t·ª´ GitHub";
  btnLoad.className = "ghost";
  btnLoad.onclick = loadFromGist;
  wrap.appendChild(btnLoad);
});


// ====== KH·ªûI CH·∫†Y ======
recompute();
// ====== üîî TH√îNG B√ÅO NH·∫ÆC NH·∫¨P C√ÇN M·ªñI S√ÅNG ======
async function requestNotificationPermission(){
  if (!("Notification" in window)) return;
  const permission = await Notification.requestPermission();
  if (permission === "granted") scheduleReminder();
}

function scheduleReminder(){
  const now = new Date();
  const next = new Date();
  next.setHours(6,50,0,0); // gi·ªù nh·∫Øc: 6h30 s√°ng
  if (next <= now) next.setDate(next.getDate() + 1); // n·∫øu ƒë√£ qua gi·ªù, d·ªùi sang mai
  const delay = next - now;

  setTimeout(() => {
    new Notification("üìä Nh·∫≠p c√¢n n·∫∑ng h√¥m nay nh√©!", {
      body: "Gi·ªØ th√≥i quen t·ªët gi√∫p b·∫°n ƒë·∫°t m·ª•c ti√™u nhanh h∆°n üí™",
      icon: "https://cdn-icons-png.flaticon.com/512/2966/2966481.png"
    });
    scheduleReminder(); // t·ª± ƒë·∫∑t l·∫°i cho ng√†y mai
  }, delay);
}

window.addEventListener("load", () => {
  requestNotificationPermission();
});

</script>



</body>
</html>
